
<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>session更换存储，实现在多台服务器共享 &mdash; WalkingSun</title>
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/vendor/primer-css/css/primer.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/vendor/primer-markdown/dist/user-content.min.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/vendor/octicons/octicons/octicons.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/components/collection.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/components/repo-card.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/sections/repo-list.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/sections/mini-repo-list.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/components/boxed-group.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/globals/common.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/vendor/share.js/dist/css/share.min.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/globals/responsive.css">
    <link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/posts/index.css">
    <!-- Latest compiled and minified CSS -->



    <link rel="canonical" href="https://walkingsun.github.io/WindBlog/2018/09/12/session_share/">
    <link rel="alternate" type="application/atom+xml" title="WalkingSun" href="https://walkingsun.github.io/WindBlog/feed.xml">
    <link rel="shortcut icon" href="https://walkingsun.github.io/WindBlog/favicon.ico">

    <meta property="og:title" content="session更换存储，实现在多台服务器共享">

    <meta name="keywords" content="php, session">
    <meta name="og:keywords" content="php, session">

    <meta name="description" content="场景web服务器有多台，每台服务器都会存贮自己的session，session无法在多台服务器共享。所以就需要更换session的存贮空间，存贮在一个共用的空间。通常为了读写速度，我们会选择存贮在内存服务上，如redis、mysql的memory存贮引擎等，本文以reddis存贮贯串上下文。">
    <meta name="og:description" content="场景web服务器有多台，每台服务器都会存贮自己的session，session无法在多台服务器共享。所以就需要更换session的存贮空间，存贮在一个共用的空间。通常为了读写速度，我们会选择存贮在内存服务上，如redis、mysql的memory存贮引擎等，本文以reddis存贮贯串上下文。">





    <meta property="og:url" content="https://walkingsun.github.io/WindBlog/2018/09/12/session_share/">
    <meta property="og:site_name" content="WalkingSun">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="zh_CN" />

    <meta property="article:published_time" content="2018-09-12">

    <script src="https://walkingsun.github.io/WindBlog/assets/vendor/jquery/dist/jquery.min.js"></script>
    <script src="https://walkingsun.github.io/WindBlog/assets/js/jquery-ui.js"></script>
    <script src="https://walkingsun.github.io/WindBlog/assets/js/main.js"></script>
</head>
<body class="" data-mz="">
<header class="site-header">
    <div class="container">
        <h1><a href="https://walkingsun.github.io/WindBlog/" title="WalkingSun"><span class="octicon octicon-mark-github"></span> WalkingSun</a></h1>
        <button class="collapsed mobile-visible" type="button" onclick="toggleMenu();">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <nav class="site-header-nav" role="navigation">

            <a href="https://walkingsun.github.io/WindBlog/" class=" site-header-nav-item" target="" title="首页">首页</a>

            <a href="https://walkingsun.github.io/WindBlog/categories/" class=" site-header-nav-item" target="" title="分类">分类</a>

            <a href="https://walkingsun.github.io/WindBlog/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a>

        </nav>
    </div>
</header>
<!-- / header -->

<section class="collection-head small geopattern" data-pattern-id="session更换存储，实现在">
    <div class="container">
        <div class="columns">
            <div class="column three-fourths">
                <div class="collection-title">
                    <h1 class="collection-header">session更换存储，实现在多台服务器共享</h1>
                    <div class="collection-info">

          <span class="meta-info">
            <span class="octicon octicon-calendar"></span> 2018/09/12
          </span>


                        <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="https://walkingsun.github.io/WindBlog/categories/#PHP" title="PHP">PHP</a>
          </span>

                        <span class="meta-info">
            <span class="octicon octicon-file-directory"></span>
            <a href="https://walkingsun.github.io/WindBlog/categories/#Nginx" title="Nginx">Nginx</a>
          </span>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- / .banner -->
<section class="container content">
    <div class="columns">
        <div class="column three-fourths" >
            <article class="article-content markdown-body">
                <h1 id="场景">场景</h1>
                <p>web服务器有多台，每台服务器都会存贮自己的session，session无法在多台服务器共享。所以就需要更换session的存贮空间，存贮在一个共用的空间。通常为了读写速度，我们会选择存贮在内存服务上，如redis、mysql的memory存贮引擎等，本文以reddis存贮贯串上下文。</p>

                <h2 id="session共享">session共享</h2>
                <h3 id="nginx-ip_hash-或者-url_hash">nginx ip_hash 或者 url_hash</h3>
                <h4 id="ip_hash">ip_hash</h4>
                <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
upstream backserver <span class="o">{</span>
    ip_hash<span class="p">;</span>
    server 192.168.0.14:88<span class="p">;</span>
    server 192.168.0.15:80<span class="p">;</span>
<span class="o">}</span>
...
</code></pre></div></div>
                <p>采用ip_hash指令解决这个问题，如果客户已经访问了某个服务器，当用户再次访问时，会将该请求通过哈希算法，自动定位到该服务器。
                    每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，解决session的问题。</p>
                <h4 id="url_hash">url_hash</h4>
                <p>按访问url的hash结果来分配请求，使每个url定向到同一个（对应的）后端服务器，后端服务器为缓存时比较有效。</p>
                <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
upstream backserver <span class="o">{</span>
    server squid1:3128<span class="p">;</span>
    server squid2:3128<span class="p">;</span>
    <span class="nb">hash</span> <span class="nv">$request_uri</span><span class="p">;</span>
    hash_method crc32<span class="p">;</span>
<span class="o">}</span>
...
</code></pre></div></div>
                <h3 id="phpini修改配置">php.ini修改配置</h3>
                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>session.save_handler = redis
session.save_path = "tcp://127.0.0.1:6379"
</code></pre></div></div>
                <p>修改完之后，重启 php-fpm。</p>
                <h3 id="通过-ini_set-函数设置">通过 ini_set() 函数设置</h3>
                <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ini_set</span><span class="p">(</span><span class="s2">"session.save_handler"</span><span class="p">,</span> <span class="s2">"redis"</span><span class="p">);</span>
<span class="nb">ini_set</span><span class="p">(</span><span class="s2">"session.save_path"</span><span class="p">,</span> <span class="s2">"tcp://127.0.0.1:6379"</span><span class="p">);</span>
</code></pre></div></div>
                <h3 id="session_set_save_handler函数设置">session_set_save_handler()函数设置</h3>
                <p>主流框架都选择用此类方法覆盖session的open、close、read、write、gc机制，容易扩展。我写了个redis的session存贮类,仅供参考：</p>
                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
//namespace openyii\framework;

class CSessionRedis //extends CSession
{
    protected $redisInstance;   //redis操作实例
    public $keyPrefix;          //键前缀
    public $lifeTime;           //生命周期

    public function __construct( $keyPrefix,$lifeTime=3600 )
    {
        $this-&gt;lifeTime = $lifeTime;
        $this-&gt;keyPrefix = $keyPrefix;
        session_set_save_handler(
            array($this, 'open'),
            array($this, 'close'),
            array($this, 'read'),
            array($this, 'write'),
            array($this, 'destroy'),
            array($this, 'gc')
        );
        if ($this-&gt;keyPrefix === null) {
            $this-&gt;keyPrefix = substr(md5(base::$app-&gt;id), 0, 5);
        }
        session_start();            //以全局变量形式保存在一个session中并且会生成一个唯一的session_id，
    }

    function open($savePath, $sessionName)
    {
        //todo $redis redis的操作实例要自己写下

          $this-&gt;redisInstance = $redis;
//        $this-&gt;redisInstance = base::$app-&gt;redis;
        return true;
    }

    function close()
    {
        return true;
    }

    function read($id)
    {
        if( !$this-&gt;redisInstance-&gt;exists($this-&gt;calculateKey($id)) ){
            $this-&gt;redisInstance-&gt;set( $this-&gt;calculateKey($id),'' );
        }
        return $this-&gt;redisInstance-&gt;get( $this-&gt;calculateKey($id) );
    }

    function write($id, $value)
    {
        return $this-&gt;redisInstance-&gt;set($this-&gt;calculateKey($id), $value, $this-&gt;lifeTime)?true:false;
    }

    function destroy($id)
    {
        $this-&gt;redisInstance-&gt;delete($this-&gt;calculateKey($id));
        if( !$this-&gt;redisInstance-&gt;exists($this-&gt;calculateKey($id)) ){
            return false;
        }
        return true;
    }

    function gc($lifetime)
    {
        //不做实现，redis本身有回收机制

        return true;
    }

    /**
     * 加密key
     * @param $id
     * @return string
     */
    protected function calculateKey($id)
    {
        return $this-&gt;keyPrefix . md5(json_encode([__CLASS__, $id]));
    }

}
</code></pre></div></div>
                <p>具体细节可以看我写的<a href="https://github.com/WalkingSun/openyii/blob/master/framework/CSessionRedis.php">php框架代码</a>,如果想自己实现，上面的代码改改就可以实现的。</p>

                <h1 id="思考">思考</h1>
                <h2 id="如果使用mysql如何存贮">如果使用mysql如何存贮？</h2>
                <p>mysql使用memory存贮引擎，设计数据表（sessionid、sessionValue 、过期时间）,重写session_set_save_handler方法。</p>

                <h2 id="如果redis是哨兵-master-slave模式session如何共享">如果redis是哨兵 master-slave模式，session如何共享？</h2>
                <p>没想清楚，咨询了老大，做法比较坑，php.ini修改配置指定redis master ip，有个守护进程的脚本检测哨兵，发生故障哨兵切换，检测到发邮件通知‘人’去手动修改php.ini master的ip，感觉匪夷所思啊！</p>

                <p>我的思路是：哨兵模式会有三个redis服务ip端口，客户端连接获取每个redis服务的info信息，如果info里包含master role，则将此master redis服务操作实例交给上面的代码，实现写操作。</p>

                <p>后面自己动手实现了吧，可行的，代码地址贴下，结合代码及说明看看，希望能帮助大家理解：</p>

                <p><a href="https://github.com/WalkingSun/openyii/blob/master/framework/CRedisHa.php">哨兵主从模式(redis服务ip可直接访问)</a></p>

                <p><a href="https://github.com/WalkingSun/openyii/blob/master/framework/CRedisServer.php">哨兵主从模式(redis服务ip不可直接访问，ip映射访问)</a></p>

            </article>
            <div class="share">
                <div class="share-component"></div>
            </div>
            <div class="comment">





                <div id="gitalk-container"></div>
                <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
                <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
                <script>
                    var gitalk = new Gitalk({
                        id: '/2018/09/12/session_share/',
                        clientID: '4d696ab7aacc8449082f',
                        clientSecret: 'd43ec7f6d0d5941f68830c5ce61f773206429ccd',
                        repo: 'WindBlog',
                        owner: 'WalkingSun',
                        admin: ['WalkingSun'],
                        labels: ['gitment'],
                        perPage: 50,
                    })
                    gitalk.render('gitalk-container')
                </script>



            </div>
        </div>
        <div class="column one-fourth">

            <h3>Search</h3>
            <div id="site_search">
                <input type="text" id="search_box" placeholder="Search">
            </div>

            <ul id="search_results"></ul>

            <link rel="stylesheet" type="text/css" href="https://walkingsun.github.io/WindBlog/assets/css/modules/sidebar-search.css">
            <script src="https://walkingsun.github.io/WindBlog/assets/js/simple-jekyll-search.min.js"></script>
            <script src="https://walkingsun.github.io/WindBlog/assets/js/search.js"></script>

            <script type="text/javascript">
                SimpleJekyllSearch({
                    searchInput: document.getElementById('search_box'),
                    resultsContainer: document.getElementById('search_results'),
                    json: 'https://walkingsun.github.io/WindBlog/assets/search_data.json',
                    searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
                    noResultsText: 'No results found',
                    limit: 10,
                    fuzzy: false,
                    exclude: ['Welcome']
                })
            </script>




            <h3 class="post-directory-title mobile-hidden">Table of Contents</h3>
            <div id="post-directory-module" class="mobile-hidden">
                <section class="post-directory">
                    <!-- Links that trigger the jumping -->
                    <!-- Added by javascript below -->
                    <dl></dl>
                </section>
            </div>

            <script src="https://walkingsun.github.io/WindBlog/assets/js/jquery.toc.js"></script>

        </div>
    </div>
</section>
<!-- /section.content -->

<footer class="container">
    <div class="site-footer" role="contentinfo">
        <div class="copyright left mobile-block">
            © 2015
            <span title="WalkingSun">WalkingSun</span>
            <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
        </div>

        <ul class="site-footer-links right mobile-hidden">
            <li>
                <a href="javascript:window.scrollTo(0,0)" >TOP</a>
            </li>
        </ul>
        <a href="https://github.com/WalkingSun/WindBlog" target="_blank" aria-label="view source code">
            <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
        </a>
        <ul class="site-footer-links mobile-hidden">

            <li>
                <a href="https://walkingsun.github.io/WindBlog/" title="首页" target="">首页</a>
            </li>

            <li>
                <a href="https://walkingsun.github.io/WindBlog/categories/" title="分类" target="">分类</a>
            </li>

            <li>
                <a href="https://walkingsun.github.io/WindBlog/wiki/" title="维基" target="">维基</a>
            </li>

            <li><a href="https://walkingsun.github.io/WindBlog/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li>
        </ul>

    </div>
</footer>
<div class="tools-wrapper">
    <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a>
</div>
<!-- / footer -->
<script src="https://walkingsun.github.io/WindBlog/assets/vendor/share.js/dist/js/share.min.js"></script>
<script src="https://walkingsun.github.io/WindBlog/assets/js/geopattern.js"></script>
<script src="https://walkingsun.github.io/WindBlog/assets/js/prism.js"></script>
<link rel="stylesheet" href="https://walkingsun.github.io/WindBlog/assets/css/globals/prism.css">
<script>
    jQuery(document).ready(function($) {
        // geopattern
        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });
        // hljs.initHighlightingOnLoad();
    });
</script>










<div style="display:none">
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-80669434-1', 'auto');
        ga('send', 'pageview');

    </script>
</div>

</body>
</html>
